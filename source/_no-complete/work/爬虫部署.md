## 申请权限

[机器申请](http://mops.mogujie.org/dops/index#/product?id=6211&name=%E5%86%85%E5%AE%B9%E6%8A%80%E6%9C%AF&tag=0&_k=out1dg)

## 登录

* 登录堡垒机命令：`ssh sushi@t2.mogujie.org -p10022`，登陆后再直接输入服务器ip即可完成登录。
* 线下机器：10.70.96.67
* 线上机器：10.80.166.121,10.80.168.21,10.80.172.196
* host工具ip:10.50.163.25
* 新host工具ip:10.80.172.196


## 切换用户
切换到 `mapp` 账户，`sudo su mapp`

centOs像puppeteer都无法运行

## 有效命令行

* `ps  -ef | grep mongo`
    * 进程查看命令
* `tail -1000f`

## 安装git、nginx、yarn、pm2

* `sudo yum install git`
* `sudo yum install nginx`
* `sudo yum install yarn`
* `npm i pm2 -g`

## linux 安装nvm

> 下载并安装

```
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash
```

> 无法访问外网安装

无法访问外网，可将nvm上传至内网cdn，下载解压后进入nvm根目录

* 下载nvm压缩包
    * `curl https://s11.mogucdn.com/mlcdn/c45406/190717_4dj5a2117b21j5d21jhc06a1kh202.zip`
* 执行`. nvm.sh`即可安装

> 重启后依然生效：

```
vim .bashrc
// 如果文件中不存在 则粘贴这行
export NVM_DIR="$HOME/nvm"
[ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh" # This loads nvm

// 生效
source .bashrc
```

> 命令

* `nvm --version`
    *  可查看版本，说明安装成功
* `nvm ls-remote`
    * 可查看node所有版本
* `nvm install <version>`(版本号) 
    * 例如：nvm install v10.6.0
* `node -v` ,`npm -v` 
    * 查看版本，说明安装成功


## 安装 Node.js

* 设置蘑菇街的镜像源：`http://webnpm.f2e.mogujie.org/`
* 黑石机器设置为：`http://npm.f2e.service.mogujie.org:7001`，`http://npm.f2e.mogujie.org` 这个域名貌似不能访问。
*` npm config set registry` `http://npm.f2e.service.mogujie.org:7001`


## 部署服务

因为目前集团的node框架采用koa，并且封装了typescript，所以在部署前需要先进行build，然后通过pm2指向build后的跟文件


## 安装puppeteer

[问题解决方案以及安装](https://luodao.me/post/puppeteer-pakeng.html)

设置被墙问题

```
npm config set puppeteer_download_host https://storage.googleapis.com.cnpmjs.org
```

## centOs7.0无法运行问题

centos必须升级到7.0以上否则会遇到依赖版本缺失问题

```
yum install ipa-gothic-fonts xorg-x11-fonts-100dpi xorg-x11-fonts-75dpi xorg-x11-utils xorg-x11-fonts-cyrillic xorg-x11-fonts-Type1 xorg-x11-fonts-misc -y

yum install pango.x86_64 libXcomposite.x86_64 libXcursor.x86_64 libXdamage.x86_64 libXext.x86_64 libXi.x86_64 libXtst.x86_64 cups-libs.x86_64 libXScrnSaver.x86_64 libXrandr.x86_64 GConf2.x86_64 alsa-lib.x86_64 atk.x86_64 gtk3.x86_64 -y

# 再安装NSS的依赖：
yum install nss.x86_64

# puppeteer的执行文件中去沙箱运行：
browser = await puppeteer.launch({
  headless: true,
  args: ['--no-sandbox', '--disable-setuid-sandbox']
});
```

## 启动ngix

/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf

