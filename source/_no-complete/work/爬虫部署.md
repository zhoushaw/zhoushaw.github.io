## 申请权限

[机器申请](http://mops.mogujie.org/dops/index#/product?id=6211&name=%E5%86%85%E5%AE%B9%E6%8A%80%E6%9C%AF&tag=0&_k=out1dg)

## 登录

* 登录堡垒机命令：ssh sushi@t2.mogujie.org -p10022，登陆后再直接输入服务器ip即可完成登录。
* 线下机器：10.70.96.67
* 线上机器：10.80.166.121,10.80.168.21

## 切换用户
切换到 `mapp` 账户，`sudo su mapp`

centOs像puppeteer都无法运行

## 安装git、Nginx

需要 sudo 权限

* sudo yum install git
* sudo yum install nginx
* nginx 的安装目录为：/usr/local/nginx/sbin/nginx
* nginx 的配置目录为：/usr/local/nginx/conf/nginx.conf

> 启动Nginx

* 测试 nginx 配置是否正确 sudo /usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf
* 第一次启动 sudo /usr/local/nginx/sbin/nginx
* 重启 sudo /usr/local/nginx/sbin/nginx -s reload
* 建议每次重启前，都检测下配置是否正确。

> 常见问题


* nginx: [emerg] getpwnam("www") failed
    * 因为没有 www 用户组，
    * 修改 nginx.conf 配置，去掉#user www注释，改成user nobody
    * 再次启动，访问 http://10.70.96.67/，可以看到 nginx 的欢迎页面

## linux 安装nvm,通过nvm安装node

```
curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash

```

or

```
wget -qO- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash

```

* source ~/.bashrc
* 通过命令 nvm --version 可查看版本，说明安装成功
* 通过 nvm ls-remote可查看node所有版本
* 通过 nvm install <version>(版本号) 例如：nvm install v10.6.0
* 安装后可通过node -v ,npm -v 查看版本，说明安装成功

### 无法访问外网安装

* 通过gitlab上传至指定仓库
* 将 nvm.zip 放到 /home/mapp/ 目录下，进行解压 unzip nvm.zip
* 参照 nvm 文档操作：https://github.com/creationix/nvm#git-install

## 安装 Node.js

* 跟本地保持一致，使用 v.8.9.4
* 在 mapp 用户下，执行 nvm install v8.9.4
* 安装完成后，Node 的路径为 /home/mapp/nvm/versions/node/v8.9.4/bin/node
* 设置蘑菇街的镜像源：http://webnpm.f2e.mogujie.org/
* 黑石机器设置为：http://npm.f2e.service.mogujie.org:7001，http://npm.f2e.mogujie.org 这个域名貌似不能访问。
* npm config set registry http://npm.f2e.service.mogujie.org:7001

## 安装 pm2

* npm i pm2 -g
* pm2 的安装路径：/home/mapp/nvm/versions/node/v8.9.4/bin/pm2


## 部署服务

因为目前集团的node框架采用koa，并且封装了typescript，所以在部署前需要先进行build，然后通过pm2指向build后的跟文件

## 更新python

[更新规则](https://www.cnblogs.com/leon-zyl/p/8422699.html)


[puppeteer依赖解决](https://github.com/GoogleChrome/puppeteer/issues/1471)

## centOs7.0无法运行问题

centos必须升级到7.0以上否则会遇到依赖版本缺失问题

```
yum install ipa-gothic-fonts xorg-x11-fonts-100dpi xorg-x11-fonts-75dpi xorg-x11-utils xorg-x11-fonts-cyrillic xorg-x11-fonts-Type1 xorg-x11-fonts-misc -y

yum install pango.x86_64 libXcomposite.x86_64 libXcursor.x86_64 libXdamage.x86_64 libXext.x86_64 libXi.x86_64 libXtst.x86_64 cups-libs.x86_64 libXScrnSaver.x86_64 libXrandr.x86_64 GConf2.x86_64 alsa-lib.x86_64 atk.x86_64 gtk3.x86_64 -y

# 再安装NSS的依赖：
yum install nss.x86_64

# puppeteer的执行文件中去沙箱运行：
browser = await puppeteer.launch({
  headless: true,
  args: ['--no-sandbox', '--disable-setuid-sandbox']
});
```

## 启动ngix

/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf

