---
title: vueæŠ€æœ¯å†…å¹•-æ•°æ®å“åº”ç³»ç»Ÿ
date: 2019-06-17 21:21:35
tags: vue
categories: vue
---


## æ•°æ®å“åº”ç³»ç»Ÿçš„åŸºæœ¬æ€è·¯

æˆ‘ä»¬éƒ½çŸ¥é“åœ¨`Vue`ä¸­å­˜åœ¨`watch`(è§‚å¯Ÿè€…)ã€‚é€šè¿‡è®¾ç½®`watch`å¯ä»¥å¯¹æ•°æ®è¿›è¡Œè§‚å¯Ÿï¼Œå½“æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯ä»¥æ‰§è¡Œå¯¹åº”çš„è§‚å¯Ÿå‡½æ•°ï¼Œä¸‹é¢ä¸ºä¾‹ï¼š

```
var ins = new Vue({
    data () {
        return {
            name: 'shaw'
        }
    }
})
ins.$watch('name', ()=>{
    console.log('nameæ•°æ®å‘ç”Ÿä¿®æ”¹');
});
```

åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨`ins.name='zhou shaw'`è¿›è¡Œä¿®æ”¹æ•°æ®æ—¶ï¼Œæ§åˆ¶å°ä¼šè¾“å‡º`nameæ•°æ®å‘ç”Ÿä¿®æ”¹`,ç°åœ¨æˆ‘ä»¬å°†åŠŸèƒ½æŠ½è±¡å‡ºæ¥ï¼š

> å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ•°æ®data

```
const data = {
    name: 'shaw'
};

```

> å‡½æ•°$watch,æ¥æ”¶ä¸¤ä¸ªå‚æ•°(è¦è§‚æµ‹çš„keyï¼Œå›è°ƒå‡½æ•°)

```
$watch(key,()=>{...})
```

> å®ç°çš„æŠ½è±¡åŠŸèƒ½


```
const data = {
    name: 'shaw'
};
$watch('name',()=>{
    console.log('name å€¼å‘ç”Ÿæ›´æ”¹');
});

data.name = 'zhou shaw';
# logï¼š name å€¼å‘ç”Ÿæ›´æ”¹
```

æˆ‘ä»¬é€šè¿‡`$watch`å‡½æ•°æ¥æ·»åŠ `data`å¯¹è±¡æ•°æ®çš„ä¾èµ–å…³ç³»ï¼Œè‹¥`data`ä¸­çš„æ•°æ®å‘ç”Ÿæ”¹å˜æ—¶å‡ºå‘å¯¹åº”`watch`å‡½æ•°ã€‚å®ç°è¿™æ ·ä¸€ä¸ªåŠŸèƒ½è¯´å¤æ‚ä¹Ÿå¤æ‚è¯´ç®€å•ä¹Ÿç®€å•ï¼Œè¯´å¤æ‚æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°å¾ˆå¤šä¾¿æ·æƒ…å†µã€å¦‚é‡å¤ä¾èµ–ã€æ·±åº¦è§‚æµ‹ï¼Œä»¥åŠå¦‚ä½•å¤„ç†æ•°ç»„ç­‰å¤šç§æƒ…å†µã€‚æˆ‘ä»¬æš‚ä¸”ä¸è€ƒè™‘è¿™äº›è¾¹ç•Œæƒ…å†µï¼Œæ¥å®ç°ä¸€ä¸ªç®€å•çš„å“åº”å¼ç³»ç»Ÿã€‚


é¦–å…ˆæˆ‘ä»¬éœ€è¦é¢ä¸´çš„ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯ï¼Œå¦‚ä½•æ£€æµ‹æ•°æ®å‘ç”Ÿäº†å˜åŒ–ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`Object.defineProperty`æ¥å¯¹å±æ€§è¿›è¡Œæ£€æµ‹ï¼š

```
const data = {
    name: 'shaw'
};
Object.defineProperty(data,'name', {
    set (newValue) {
        console.log('name å€¼å‘ç”Ÿæ›´æ”¹');
    },
    get () {
        console.log('è¯»å–äº†å±æ€§name')
    }
});
```

é€šè¿‡`defineProperty`å®šä¹‰æˆ‘ä»¬åŠ«æŒäº†dataå¯¹è±¡çš„nameå±æ€§æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥å°†åŠ«æŒçš„æ–¹æ³•å°è£…è‡³`watch`æ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹ï¼š


```
const data = {
    name: 'shaw'
};
$watch = function (key, fn) {
    Object.defineProperty(data,'name', {
        set (newValue) {
            fn();
        },
        get () {
            console.log('è¯»å–äº†å±æ€§name');
        }
    });
}
```

ä¸Šé¢çš„ä»£ç å·²ç»ç®€å•å®ç°äº†å¯¹æ•°æ®çš„è§‚æµ‹ï¼Œä½†æ˜¯å¤§å®¶ä¸éš¾å‘ç°å…¶ä¸­å­˜åœ¨çš„é—®é¢˜ï¼Œä¸Šé¢ä¾‹å­ä¸­`set`å‡½æ•°å¹¶æœªè®¾ç½®å±æ€§æ–°çš„èµ‹å€¼ï¼Œå¹¶ä¸”`get`å‡½æ•°å¹¶æœªè¿”å›è·å–çš„å€¼ä¼šå¯¼è‡´å±æ€§çš„è®¾ç½®å’Œè·å–å¤±æ•ˆã€‚å¹¶ä¸”ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬æˆ‘æ— æ³•å¯¹ä¸€ä¸ªå¯¹è±¡çš„å±æ€§æ”¶é›†å¤šä¸ªä¾èµ–ï¼Œå¹¶ä¸”æˆ‘ä»¬æ¯æ¬¡è°ƒç”¨`watch`éƒ½å¯¹å±æ€§é‡æ–°å®šä¹‰äº†`set`å’Œ`get`,å½“å±æ€§è¿˜å­˜åœ¨å…¶ä»–ä¾èµ–æ—¶è¿™æ ·ä¼šè¦†ç›–åŸæœ‰çš„ä¾èµ–ï¼Œæˆ‘ä»¬ä¸å¦¨å±•å¼€ğŸ¤”ï¼Œ`set`å‡½æ•°å¯ä»¥ç”¨äºè§¦å‘æ•°æ®æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬å¯ä¸å¯ä»¥é€šè¿‡`get`å‡½æ•°æ¥è¿›è¡Œä¾èµ–æ”¶é›†å‘¢

```
var data = {
    name: 'shaw',
    age: 23
};

let Target;

let dep = [];

let val = data['name'];
Object.defineProperty(data, 'name', {
    set(newValue) {
        // è®¾ç½®æ–°å€¼ä¸æ—§å€¼ç›¸ç­‰ï¼Œä¸è¿›è¡Œä¾èµ–
        if (val === newValue) return;
        // æ‰§è¡Œä¾èµ–
        dep.forEach(fn => fn());
        val = newValue
    },
    get() {
        // æœ‰ä¾èµ–è¿›è¡Œæ”¶é›†
        if (Target) dep.push(Target);
        return val;
    }
});

$watch = function (key,fn) {
    Target = fn;
    data[key];
}

$watch('name', () => {
    console.log('è®¾ç½®äº†name');
})

$watch('name', () => {
    console.log('å¤šé‡ä¾èµ–ï¼Œå•¦å•¦å•¦');
})

data.name = 'zhou shaw';
```

ä¸Šè¿°ä»£ç å¹¶æœªå¯¹å…¶`data`å±æ€§è¿›è¡Œæ•°æ®å“åº”ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡éå†æ·»åŠ ä¾èµ–å…³ç³»ã€‚å¹¶ä¸”æˆ‘ä»¬ä¼šå‘ç°è‹¥æˆ‘ä»¬é€šè¿‡è®¿é—®æ•°æ®ä¾¿æ”¶é›†äº†ä¾èµ–ï¼Œé‚£ä¹ˆä¼šè§¦å‘å¤§é‡çš„é‡å¤ä¾èµ–æ”¶é›†åé¢æˆ‘ä»¬ä¼šè®²è§£å¦‚ä½•è§£å†³ï¼š

```
var data = {
    name: 'shaw',
    age: 23
};

let Target; // ç”¨äºç¼“å­˜ä¾èµ–å‡½æ•°

for (let key in data) {
    let dep = [];
    let val = data[key];
    Object.defineProperty(data, key, {
        set(newValue) {
            if (val === newValue) return; // è®¾ç½®æ–°å€¼ä¸æ—§å€¼ç›¸ç­‰ï¼Œä¸è¿›è¡Œä¾èµ–
            dep.forEach(fn => fn()); // æ‰§è¡Œä¾èµ–
            val = newValue
        },
        get() {
            if (Target) dep.push(Target); // æœ‰ä¾èµ–è¿›è¡Œæ”¶é›†
            return val;
        }
    });
}

let $watch = function (key,fn) {
    Target = fn;
    data[key];
}
```

ä½†å¦‚æœæ•°æ®ç»“æ„æ˜¯è¿™æ ·å‘¢ï¼š

```
var data = {
    name: 'shaw',
    infos: {
        phone: '17xxx',
        wechat: 'xxx'
    }
};
```

æˆ‘ä»¬ä¼šå‘ç°æˆ‘ä»¬å¹¶æ²¡æœ‰å¯¹æ·±å±‚æ¬¡å¯¹è±¡ç›‘å¬ï¼Œå¦‚æœæ•°æ®ç»“æ„æ›´ä¸ºå¤æ‚å‘¢ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®æ‹¦æˆªæ–¹æ³•å°è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œå¯¹æ•°æ®å¯¹è±¡è¿›è¡Œé€’å½’éå†ï¼Œå°†æ‰€æœ‰å±æ€§éƒ½æ·»åŠ ä¾èµ–ï¼Œ

```

let Target; // ç”¨äºç¼“å­˜ä¾èµ–å‡½æ•°

function walk(data) {
    for (let key in data) {
        let dep = [];
        let val = data[key];
        // å½“æ•°æ®ä¸ºå¯¹è±¡ç±»å‹æ—¶é€’å½’éå†
        if (Object.prototype.toString.call(val) === '[object Object]') { 
            walk(val);
        }

        Object.defineProperty(data, key, {
            set(newValue) {
                if (val === newValue) return; // è®¾ç½®æ–°å€¼ä¸æ—§å€¼ç›¸ç­‰ï¼Œä¸è¿›è¡Œä¾èµ–
                dep.forEach(fn => fn()); // æ‰§è¡Œä¾èµ–
                val = newValue
            },
            get() {
                if (Target) dep.push(Target); // æœ‰ä¾èµ–è¿›è¡Œæ”¶é›†
                return val;
            }
        });
    }
}

walk(data);

let $watch = function (key,fn) {
    Target = fn;
    data[key];
}
```

å°½ç®¡å¯¹æ•°æ®è¿›è¡Œæ·±åº¦è§‚å¯Ÿäº†ï¼Œä½†æˆ‘ä»¬ä¼šå‘ç°ï¼Œæˆ‘ä»¬çš„`watch`å‡½æ•°å¹¶ä¸ä¼šå¯¹`infos.wechat`è¿›è¡Œè§‚å¯Ÿï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹`$watch`å‡½æ•°è¿›è¡Œæ”¹é€ ï¼Œè®©å…¶æ”¯æŒ`infos.wechat`ä¾èµ–æ”¶é›†ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³å®ç°çš„æ•ˆæœæ˜¯ï¼š

```
$watch('infos.wechat', () => {
    console.log('ä¿®æ”¹äº†wechat');
})
```

ç”±äºæˆ‘ä»¬å·²ç»å®ç°äº†æ•°æ®è¿›è¡Œè®¿é—®å³å¯æ”¶é›†ä¾èµ–ï¼Œä½†æˆ‘ä»¬æ— æ³•ç›´æ¥é€šè¿‡`infos.wechat`æ”¶é›†ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶è½¬æ¢æˆ`data['infos']['wechat']`

```
var data = {
    name: 'shaw',
    infos: {
        wechat: '466'
    }
};

let $watch = function (key,fn) {

    Target = fn;

    if (/\./.test(key)) {
        let paths = key.split('.');
        let obj = data;
        paths.forEach((path) => {
            obj = obj[path];
        });
        return;
    }

    data[key];
}
```

